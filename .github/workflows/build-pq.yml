name: Build with PQ Toxcore

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:
    inputs:
      toxcore_repo:
        description: 'c-toxcore-pq repository (owner/repo)'
        required: false
        default: 'moscowchill/c-toxcore-pq'
      toxcore_ref:
        description: 'c-toxcore-pq branch/tag to build'
        required: false
        default: 'master'

concurrency:
  group: build-pq-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ##############################################################################
  # Linux builds with PQ toxcore
  ##############################################################################

  build-linux-pq:
    name: Linux PQ (${{ matrix.distro }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        distro: [ubuntu, fedora]
        include:
          - distro: ubuntu
            image: ubuntu:24.04
            pkg_manager: apt-get
          - distro: fedora
            image: fedora:40
            pkg_manager: dnf

    container:
      image: ${{ matrix.image }}

    steps:
      - name: Install dependencies (Ubuntu)
        if: matrix.distro == 'ubuntu'
        run: |
          apt-get update
          apt-get install -y \
            git cmake ninja-build g++ wget \
            autoconf automake libtool \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-svg-dev \
            libopus-dev libvpx-dev \
            libavcodec-dev libavdevice-dev libavformat-dev libavutil-dev libswscale-dev \
            libopenal-dev libexif-dev libqrencode-dev libsqlcipher-dev \
            pkg-config

      - name: Install dependencies (Fedora)
        if: matrix.distro == 'fedora'
        run: |
          dnf install -y \
            git cmake ninja-build gcc-c++ wget \
            autoconf automake libtool \
            qt6-qtbase-devel qt6-qttools-devel qt6-qtsvg-devel \
            opus-devel libvpx-devel \
            ffmpeg-free-devel openal-soft-devel libexif-devel \
            qrencode-devel sqlcipher-devel \
            pkgconf-pkg-config

      - name: Build libsodium with ML-KEM support
        run: |
          # Build from git master branch - stable releases don't have ML-KEM yet
          # c-toxcore-pq expects ML-KEM from libsodium master branch
          git clone --depth 1 https://github.com/jedisct1/libsodium.git libsodium-git
          cd libsodium-git
          # Generate configure script using autoreconf (autogen.sh just prints a warning now)
          autoreconf -fi
          # Install to /opt/libsodium-pq with explicit lib dir to avoid lib64 issues
          ./configure --prefix=/opt/libsodium-pq --libdir=/opt/libsodium-pq/lib
          make -j$(nproc)
          make install
          echo "/opt/libsodium-pq/lib" > /etc/ld.so.conf.d/libsodium-pq.conf
          ldconfig
          # Debug: verify installation
          echo "=== libsodium installed files ==="
          ls -la /opt/libsodium-pq/lib/
          cat /opt/libsodium-pq/lib/pkgconfig/libsodium.pc
          # Verify ML-KEM symbols are present
          echo "=== Checking for ML-KEM symbols ==="
          nm -D /opt/libsodium-pq/lib/libsodium.so | grep -i mlkem || echo "No mlkem symbols found"
          nm -D /opt/libsodium-pq/lib/libsodium.so | grep -i kem || echo "No kem symbols found"
          # List ALL crypto symbols to see what's available
          echo "=== All crypto symbols ==="
          nm -D /opt/libsodium-pq/lib/libsodium.so | grep "T.*crypto" | head -50

      - name: Checkout c-toxcore-pq
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.toxcore_repo || 'moscowchill/c-toxcore-pq' }}
          ref: ${{ github.event.inputs.toxcore_ref || 'master' }}
          path: c-toxcore-pq
          submodules: recursive

      - name: Build c-toxcore-pq
        run: |
          cd c-toxcore-pq
          rm -rf build && mkdir build && cd build
          export PKG_CONFIG_PATH=/opt/libsodium-pq/lib/pkgconfig:$PKG_CONFIG_PATH
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=/opt/libsodium-pq \
            -DCMAKE_INSTALL_PREFIX=/opt/toxcore-pq \
            -DCMAKE_INSTALL_LIBDIR=lib \
            -DCMAKE_INSTALL_RPATH=/opt/libsodium-pq/lib \
            -DBUILD_TOXAV=ON \
            -DBOOTSTRAP_DAEMON=OFF
          ninja
          ninja install
          echo "/opt/toxcore-pq/lib" >> /etc/ld.so.conf.d/libsodium-pq.conf
          ldconfig
          # Debug: verify installation
          echo "=== toxcore installed files ==="
          ls -la /opt/toxcore-pq/lib/
          cat /opt/toxcore-pq/lib/pkgconfig/toxcore.pc || cat /opt/toxcore-pq/lib/pkgconfig/libtoxcore.pc || echo "No .pc file found"

      - name: Checkout pqTox
        uses: actions/checkout@v4
        with:
          path: pqtox

      - name: Build pqTox
        env:
          PKG_CONFIG_PATH: /opt/libsodium-pq/lib/pkgconfig:/opt/toxcore-pq/lib/pkgconfig
          LD_LIBRARY_PATH: /opt/libsodium-pq/lib:/opt/toxcore-pq/lib
        run: |
          cd pqtox
          rm -rf build && mkdir build && cd build
          export PKG_CONFIG_PATH=/opt/libsodium-pq/lib/pkgconfig:/opt/toxcore-pq/lib/pkgconfig:$PKG_CONFIG_PATH
          # Debug: check what pkg-config finds
          echo "=== pkg-config debug ==="
          pkg-config --libs --cflags libsodium || echo "libsodium not found via pkg-config"
          pkg-config --libs --cflags toxcore || pkg-config --libs --cflags libtoxcore || echo "toxcore not found via pkg-config"
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="/opt/libsodium-pq;/opt/toxcore-pq" \
            -DCMAKE_INSTALL_RPATH="/opt/libsodium-pq/lib;/opt/toxcore-pq/lib" \
            -DSTRICT_OPTIONS=ON
          ninja

      - name: Run tests
        env:
          LD_LIBRARY_PATH: /opt/libsodium-pq/lib:/opt/toxcore-pq/lib
        run: |
          cd pqtox/build
          ctest --output-on-failure -j$(nproc)

      - name: Verify PQ support
        run: |
          cd pqtox/build
          # Check that PQ support was detected
          echo "=== CMakeCache PQ status ==="
          grep -E "(PQTOX_PQ_SUPPORT|HAVE_TOX_PQ)" CMakeCache.txt || echo "No PQ variables found"
          grep "PQTOX_PQ_SUPPORT:INTERNAL=TRUE" CMakeCache.txt && echo "PQ support enabled!" || echo "WARNING: PQ support not detected"

  ##############################################################################
  # Windows cross-compilation with PQ toxcore
  ##############################################################################

  build-windows-pq:
    name: Windows PQ (${{ matrix.arch }}, ${{ matrix.build_type }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
        build_type: [Debug, Release]

    steps:
      - name: Install MinGW and build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            mingw-w64 mingw-w64-tools \
            cmake ninja-build nasm yasm \
            wget unzip p7zip-full nsis

      - name: Set environment
        run: |
          echo "TOOLCHAIN_PREFIX=x86_64-w64-mingw32" >> $GITHUB_ENV
          echo "INSTALL_PREFIX=$HOME/pq-windows" >> $GITHUB_ENV

      - name: Cache Windows dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: ~/pq-windows
          key: pq-windows-deps-${{ matrix.arch }}-v2

      - name: Build libsodium for Windows
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          mkdir -p $INSTALL_PREFIX
          wget -q https://download.libsodium.org/libsodium/releases/libsodium-1.0.20.tar.gz
          tar xzf libsodium-1.0.20.tar.gz
          cd libsodium-1.0.20
          ./configure \
            --host=$TOOLCHAIN_PREFIX \
            --prefix=$INSTALL_PREFIX \
            --enable-static --disable-shared
          make -j$(nproc) && make install

      - name: Build opus for Windows
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          wget -q https://downloads.xiph.org/releases/opus/opus-1.5.2.tar.gz
          tar xzf opus-1.5.2.tar.gz
          cd opus-1.5.2
          ./configure \
            --host=$TOOLCHAIN_PREFIX \
            --prefix=$INSTALL_PREFIX \
            --enable-static --disable-shared --disable-doc
          make -j$(nproc) && make install

      - name: Build libvpx for Windows
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/webmproject/libvpx/archive/refs/tags/v1.14.1.tar.gz -O libvpx.tar.gz
          tar xzf libvpx.tar.gz
          cd libvpx-1.14.1
          CROSS=$TOOLCHAIN_PREFIX- ./configure \
            --target=x86_64-win64-gcc \
            --prefix=$INSTALL_PREFIX \
            --enable-static --disable-shared \
            --disable-examples --disable-tools --disable-docs
          make -j$(nproc) && make install

      - name: Checkout c-toxcore-pq
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.toxcore_repo || 'moscowchill/c-toxcore-pq' }}
          ref: ${{ github.event.inputs.toxcore_ref || 'master' }}
          path: c-toxcore-pq
          submodules: recursive

      - name: Build c-toxcore-pq for Windows
        run: |
          cd c-toxcore-pq
          rm -rf build && mkdir build && cd build

          cat > toolchain.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Windows)
          set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
          set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)
          set(CMAKE_RC_COMPILER x86_64-w64-mingw32-windres)
          set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32 $ENV{HOME}/pq-windows)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          EOF

          export PKG_CONFIG_PATH=$INSTALL_PREFIX/lib/pkgconfig
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_PREFIX_PATH=$INSTALL_PREFIX \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TOXAV=ON \
            -DBOOTSTRAP_DAEMON=OFF \
            -DENABLE_STATIC=ON \
            -DENABLE_SHARED=OFF

          make -j$(nproc)
          make install

      - name: Upload Windows PQ toxcore
        uses: actions/upload-artifact@v4
        with:
          name: toxcore-pq-windows-${{ matrix.arch }}-${{ matrix.build_type }}
          path: ~/pq-windows

  ##############################################################################
  # macOS builds with PQ toxcore
  ##############################################################################

  build-macos-pq:
    name: macOS PQ (${{ matrix.arch }})
    runs-on: ${{ matrix.arch == 'arm64' && 'macos-14' || 'macos-15-intel' }}
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64]

    steps:
      - name: Install dependencies
        run: |
          brew install cmake ninja opus libvpx \
            ffmpeg openal-soft libexif qrencode sqlcipher qt@6 \
            autoconf automake libtool

      - name: Build libsodium with ML-KEM support
        run: |
          # Unlink brew's libsodium to avoid conflicts
          brew unlink libsodium 2>/dev/null || true

          # Build from git master branch - stable releases don't have ML-KEM yet
          # c-toxcore-pq expects ML-KEM from libsodium master branch
          git clone --depth 1 https://github.com/jedisct1/libsodium.git libsodium-git
          cd libsodium-git
          # Generate configure script using autoreconf (autogen.sh just prints a warning now)
          autoreconf -fi
          ./configure --prefix=$HOME/libsodium
          make -j$(sysctl -n hw.ncpu)
          make install
          # Debug: verify installation
          echo "=== libsodium installed files ==="
          ls -la $HOME/libsodium/lib/
          cat $HOME/libsodium/lib/pkgconfig/libsodium.pc
          # Verify ML-KEM symbols are present
          echo "=== Checking for ML-KEM symbols ==="
          nm -g $HOME/libsodium/lib/libsodium.dylib | grep -i mlkem || echo "No mlkem symbols found"
          nm -g $HOME/libsodium/lib/libsodium.dylib | grep -i kem || echo "No kem symbols found"
          echo "=== All crypto symbols ==="
          nm -g $HOME/libsodium/lib/libsodium.dylib | grep "T.*_crypto" | head -50

      - name: Checkout c-toxcore-pq
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.toxcore_repo || 'moscowchill/c-toxcore-pq' }}
          ref: ${{ github.event.inputs.toxcore_ref || 'master' }}
          path: c-toxcore-pq
          submodules: recursive

      - name: Build c-toxcore-pq
        run: |
          cd c-toxcore-pq
          rm -rf build && mkdir build && cd build
          export PKG_CONFIG_PATH=$HOME/libsodium/lib/pkgconfig:$PKG_CONFIG_PATH
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=$HOME/libsodium \
            -DCMAKE_INSTALL_PREFIX=$HOME/toxcore-pq \
            -DCMAKE_INSTALL_RPATH=$HOME/libsodium/lib \
            -DBUILD_TOXAV=ON \
            -DBOOTSTRAP_DAEMON=OFF
          ninja
          ninja install
          # Debug: verify installation
          echo "=== toxcore installed files ==="
          ls -la $HOME/toxcore-pq/lib/
          cat $HOME/toxcore-pq/lib/pkgconfig/toxcore.pc || cat $HOME/toxcore-pq/lib/pkgconfig/libtoxcore.pc || echo "No .pc file found"

      - name: Checkout pqTox
        uses: actions/checkout@v4
        with:
          path: pqtox

      - name: Build pqTox
        run: |
          cd pqtox
          rm -rf build && mkdir build && cd build
          export PKG_CONFIG_PATH=$HOME/libsodium/lib/pkgconfig:$HOME/toxcore-pq/lib/pkgconfig:$PKG_CONFIG_PATH
          export DYLD_LIBRARY_PATH=$HOME/libsodium/lib:$HOME/toxcore-pq/lib
          # Debug: check what pkg-config finds
          echo "=== pkg-config debug ==="
          pkg-config --libs --cflags libsodium || echo "libsodium not found via pkg-config"
          pkg-config --libs --cflags toxcore || pkg-config --libs --cflags libtoxcore || echo "toxcore not found via pkg-config"
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$HOME/libsodium;$HOME/toxcore-pq;$(brew --prefix qt@6)" \
            -DCMAKE_INSTALL_RPATH="$HOME/libsodium/lib;$HOME/toxcore-pq/lib" \
            -DSTRICT_OPTIONS=ON
          ninja

      - name: Run tests
        run: |
          cd pqtox/build
          export DYLD_LIBRARY_PATH=$HOME/libsodium/lib:$HOME/toxcore-pq/lib
          ctest --output-on-failure -j$(sysctl -n hw.ncpu)

      - name: Verify PQ support
        run: |
          cd pqtox/build
          # Check that PQ support was detected
          echo "=== CMakeCache PQ status ==="
          grep -E "(PQTOX_PQ_SUPPORT|HAVE_TOX_PQ)" CMakeCache.txt || echo "No PQ variables found"
          grep "PQTOX_PQ_SUPPORT:INTERNAL=TRUE" CMakeCache.txt && echo "PQ support enabled!" || echo "WARNING: PQ support not detected"

      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: pqtox-macos-${{ matrix.arch }}
          path: pqtox/build/pqTox.app
          if-no-files-found: ignore
